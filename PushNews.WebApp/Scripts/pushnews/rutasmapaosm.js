var datosSim = { "Rutas": [{ "Descripcion": "Piedad", "HermandadID": 30, "InicioDescripcion": "", "InicioFecha": "/Date(1555513500000)/", "InicioLatitud": 0, "InicioLongitud": 0, "EntradaEnCarreraOficial": "", "CarreraOficialLatitud": 0, "CarreraOficialLongitud": 0, "FinDescripcion": "", "FinFecha": "/Date(1555546200000)/", "FinLatitud": 0, "FinLongitud": 0, "Velocidad": 0, "Distancia": 0, "CabezaFecha": null, "CabezaDireccion": "", "CabezaLatitud": null, "CabezaLongitud": null, "ColaFecha": null, "ColaDireccion": "", "ColaLatitud": null, "ColaLongitud": null, "Posiciones": [] }], "Hermandades": [{ "HermandadID": 7, "Nombre": "Entrada Triunfal", "IglesiaNombre": "Parroquia de San Lorenzo Mártir", "IglesiaDireccion": "", "IglesiaLatitud": 37.888387, "IglesiaLongitud": -4.768917, "Activo": true, "LogotipoDocumentoID": 433, "LogotipoUrl": "Home/LogotipoHermandad/7", "MiniaturaUrl": "Home/MiniaturaHermandad/7", "Tags": "DOMINGORAMOS" }, { "HermandadID": 8, "Nombre": "Penas de Santiago", "IglesiaNombre": "Parroquia de Santiago Apóstol", "IglesiaDireccion": "", "IglesiaLatitud": 37.882002, "IglesiaLongitud": -4.769575, "Activo": true, "LogotipoDocumentoID": 434, "LogotipoUrl": "Home/LogotipoHermandad/8", "MiniaturaUrl": "Home/MiniaturaHermandad/8", "Tags": "DOMINGORAMOS" }, { "HermandadID": 9, "Nombre": "Amor", "IglesiaNombre": "Parroquia de Jesús Divino Obrero", "IglesiaDireccion": "", "IglesiaLatitud": 37.866935, "IglesiaLongitud": -4.773235, "Activo": true, "LogotipoDocumentoID": 435, "LogotipoUrl": "Home/LogotipoHermandad/9", "MiniaturaUrl": "Home/MiniaturaHermandad/9", "Tags": "DOMINGORAMOS" }, { "HermandadID": 10, "Nombre": "Huerto", "IglesiaNombre": "Parroquia de San Francisco y San Eulogio", "IglesiaDireccion": "", "IglesiaLatitud": 37.88133, "IglesiaLongitud": -4.77609, "Activo": true, "LogotipoDocumentoID": 436, "LogotipoUrl": "Home/LogotipoHermandad/10", "MiniaturaUrl": "Home/MiniaturaHermandad/10", "Tags": "DOMINGORAMOS" }, { "HermandadID": 11, "Nombre": "Esperanza", "IglesiaNombre": "Real Parroquia de San Andrés Apóstol", "IglesiaDireccion": "", "IglesiaLatitud": 37.88572, "IglesiaLongitud": -4.77469, "Activo": true, "LogotipoDocumentoID": 437, "LogotipoUrl": "Home/LogotipoHermandad/11", "MiniaturaUrl": "Home/MiniaturaHermandad/11", "Tags": "DOMINGORAMOS" }, { "HermandadID": 12, "Nombre": "Rescatado", "IglesiaNombre": "Iglesia de Nuestra Señora de Gracia", "IglesiaDireccion": "", "IglesiaLatitud": 37.891443, "IglesiaLongitud": -4.765757, "Activo": true, "LogotipoDocumentoID": 438, "LogotipoUrl": "Home/LogotipoHermandad/12", "MiniaturaUrl": "Home/MiniaturaHermandad/12", "Tags": "DOMINGORAMOS" }, { "HermandadID": 13, "Nombre": "Merced", "IglesiaNombre": "Parroquia de San Antonio de Padua", "IglesiaDireccion": "", "IglesiaLatitud": 37.89674, "IglesiaLongitud": -4.767447, "Activo": true, "LogotipoDocumentoID": 439, "LogotipoUrl": "Home/LogotipoHermandad/13", "MiniaturaUrl": "Home/MiniaturaHermandad/13", "Tags": "LUNESSANTO" }, { "HermandadID": 14, "Nombre": "Vera Cruz", "IglesiaNombre": "Parroquia de San José y Espíritu Santo", "IglesiaDireccion": "", "IglesiaLatitud": 37.874813, "IglesiaLongitud": -4.774648, "Activo": true, "LogotipoDocumentoID": 441, "LogotipoUrl": "Home/LogotipoHermandad/14", "MiniaturaUrl": "Home/MiniaturaHermandad/14", "Tags": "LUNESSANTO" }, { "HermandadID": 15, "Nombre": "Estrella", "IglesiaNombre": "Parroquia de San Fernando", "IglesiaDireccion": "", "IglesiaLatitud": 37.893865, "IglesiaLongitud": -4.78542, "Activo": true, "LogotipoDocumentoID": 442, "LogotipoUrl": "Home/LogotipoHermandad/15", "MiniaturaUrl": "Home/MiniaturaHermandad/15", "Tags": "LUNESSANTO" }, { "HermandadID": 16, "Nombre": "Sentencia", "IglesiaNombre": "Parroquia de San Nicolás de la Villa", "IglesiaDireccion": "", "IglesiaLatitud": 37.88481, "IglesiaLongitud": -4.78214, "Activo": true, "LogotipoDocumentoID": 443, "LogotipoUrl": "Home/LogotipoHermandad/16", "MiniaturaUrl": "Home/MiniaturaHermandad/16", "Tags": "LUNESSANTO" }, { "HermandadID": 17, "Nombre": "Via Crucis", "IglesiaNombre": "Parroquia de San Juan y Todos los Santos (Trinidad)", "IglesiaDireccion": "", "IglesiaLatitud": 37.88248, "IglesiaLongitud": -4.78381, "Activo": true, "LogotipoDocumentoID": 444, "LogotipoUrl": "Home/LogotipoHermandad/17", "MiniaturaUrl": "Home/MiniaturaHermandad/17", "Tags": "LUNESSANTO" }, { "HermandadID": 18, "Nombre": "Ánimas", "IglesiaNombre": "Parroquia de San Lorenzo Mártir", "IglesiaDireccion": "", "IglesiaLatitud": 37.888078, "IglesiaLongitud": -4.769445, "Activo": true, "LogotipoDocumentoID": 445, "LogotipoUrl": "Home/LogotipoHermandad/18", "MiniaturaUrl": "Home/MiniaturaHermandad/18", "Tags": "LUNESSANTO" }, { "HermandadID": 19, "Nombre": "Agonía", "IglesiaNombre": "Parroquia de Santa Victoria (Barriada El Naranjo)", "IglesiaDireccion": "", "IglesiaLatitud": 37.89772, "IglesiaLongitud": -4.77401, "Activo": true, "LogotipoDocumentoID": 446, "LogotipoUrl": "Home/LogotipoHermandad/19", "MiniaturaUrl": "Home/MiniaturaHermandad/19", "Tags": "MARTESSANTO" }, { "HermandadID": 20, "Nombre": "Universitaria", "IglesiaNombre": "Iglesia del Juramento de San Rafael", "IglesiaDireccion": "", "IglesiaLatitud": 37.88845, "IglesiaLongitud": -4.7703, "Activo": true, "LogotipoDocumentoID": 447, "LogotipoUrl": "Home/LogotipoHermandad/20", "MiniaturaUrl": "Home/MiniaturaHermandad/20", "Tags": "MARTESSANTO" }, { "HermandadID": 21, "Nombre": "Sangre", "IglesiaNombre": "Iglesia Conventual del Santo Ángel PP Capuchinos", "IglesiaDireccion": "", "IglesiaLatitud": 37.888042, "IglesiaLongitud": -4.777197, "Activo": true, "LogotipoDocumentoID": 448, "LogotipoUrl": "Home/LogotipoHermandad/21", "MiniaturaUrl": "Home/MiniaturaHermandad/21", "Tags": "MARTESSANTO" }, { "HermandadID": 22, "Nombre": "Buen Suceso", "IglesiaNombre": "Parroquia de San Andrés Apóstol", "IglesiaDireccion": "", "IglesiaLatitud": 37.885768, "IglesiaLongitud": -4.772422, "Activo": true, "LogotipoDocumentoID": 449, "LogotipoUrl": "Home/LogotipoHermandad/22", "MiniaturaUrl": "Home/MiniaturaHermandad/22", "Tags": "MARTESSANTO" }, { "HermandadID": 23, "Nombre": "Santa Faz", "IglesiaNombre": "Parroquia de San Juan y Todos los Santos (Trinidad)", "IglesiaDireccion": "", "IglesiaLatitud": 37.882608, "IglesiaLongitud": -4.783012, "Activo": true, "LogotipoDocumentoID": 450, "LogotipoUrl": "Home/LogotipoHermandad/23", "MiniaturaUrl": "Home/MiniaturaHermandad/23", "Tags": "MARTESSANTO" }, { "HermandadID": 24, "Nombre": "Prendimiento", "IglesiaNombre": "Santuario de María Auxiliadora", "IglesiaDireccion": "", "IglesiaLatitud": 37.88852, "IglesiaLongitud": -4.76859, "Activo": true, "LogotipoDocumentoID": 451, "LogotipoUrl": "Home/LogotipoHermandad/24", "MiniaturaUrl": "Home/MiniaturaHermandad/24", "Tags": "MARTESSANTO" }, { "HermandadID": 25, "Nombre": "Perdón", "IglesiaNombre": "Iglesia de San Roque", "IglesiaDireccion": "Calle Buen Pastor", "IglesiaLatitud": 37.88063262022347, "IglesiaLongitud": -4.7816336216735635, "Activo": true, "LogotipoDocumentoID": 452, "LogotipoUrl": "Home/LogotipoHermandad/25", "MiniaturaUrl": "Home/MiniaturaHermandad/25", "Tags": "MIERCOLESSANTO" }, { "HermandadID": 26, "Nombre": "Calvario", "IglesiaNombre": "Parroquia de San Lorenzo Mártir", "IglesiaDireccion": "Plaza de San Lorenzo, 5, 14002 Córdoba, España", "IglesiaLatitud": 37.88838, "IglesiaLongitud": -4.76917, "Activo": true, "LogotipoDocumentoID": 453, "LogotipoUrl": "Home/LogotipoHermandad/26", "MiniaturaUrl": "Home/MiniaturaHermandad/26", "Tags": "MIERCOLESSANTO" }, { "HermandadID": 27, "Nombre": "La Paz", "IglesiaNombre": "Iglesia conventual del Santo Ángel (PP. Capuchinos)", "IglesiaDireccion": "Plaza de Capuchinos", "IglesiaLatitud": 37.888166118289675, "IglesiaLongitud": -4.77735857406617, "Activo": true, "LogotipoDocumentoID": 454, "LogotipoUrl": "Home/LogotipoHermandad/27", "MiniaturaUrl": "Home/MiniaturaHermandad/27", "Tags": "MIERCOLESSANTO" }, { "HermandadID": 28, "Nombre": "Misericordia", "IglesiaNombre": "Basílica menor de San Pedro", "IglesiaDireccion": "Plaza de San Pedro", "IglesiaLatitud": 37.88262061205746, "IglesiaLongitud": -4.771746007843035, "Activo": true, "LogotipoDocumentoID": 456, "LogotipoUrl": "Home/LogotipoHermandad/28", "MiniaturaUrl": "Home/MiniaturaHermandad/28", "Tags": "MIERCOLESSANTO" }, { "HermandadID": 29, "Nombre": "Pasión", "IglesiaNombre": "Iglesia de San Basilio", "IglesiaDireccion": "Calle San Basilio", "IglesiaLatitud": 37.876088195006844, "IglesiaLongitud": -4.784288904151936, "Activo": true, "LogotipoDocumentoID": 457, "LogotipoUrl": "Home/LogotipoHermandad/29", "MiniaturaUrl": "Home/MiniaturaHermandad/29", "Tags": "MIERCOLESSANTO" }, { "HermandadID": 30, "Nombre": "Piedad", "IglesiaNombre": "Parroquia san Antonio María Claret", "IglesiaDireccion": "Calle Sierra de Guadarrama", "IglesiaLatitud": 37.882193338733636, "IglesiaLongitud": -4.822293927536066, "Activo": true, "LogotipoDocumentoID": 458, "LogotipoUrl": "Home/LogotipoHermandad/30", "MiniaturaUrl": "Home/MiniaturaHermandad/30", "Tags": "MIERCOLESSANTO" }, { "HermandadID": 31, "Nombre": "Nazareno", "IglesiaNombre": "Iglesia Hospital de Jesús Nazareno", "IglesiaDireccion": "Calle Jesús Nazareno", "IglesiaLatitud": 37.88837774749391, "IglesiaLongitud": -4.7713086490713295, "Activo": true, "LogotipoDocumentoID": 459, "LogotipoUrl": "Home/LogotipoHermandad/31", "MiniaturaUrl": "Home/MiniaturaHermandad/31", "Tags": "JUEVESSANTO" }, { "HermandadID": 32, "Nombre": "Caridad", "IglesiaNombre": "Parroquia de San Francisco y San Eulogio", "IglesiaDireccion": "Compás de San Francisco", "IglesiaLatitud": 37.88162523471786, "IglesiaLongitud": -4.7754986283111975, "Activo": true, "LogotipoDocumentoID": 460, "LogotipoUrl": "Home/LogotipoHermandad/32", "MiniaturaUrl": "Home/MiniaturaHermandad/32", "Tags": "JUEVESSANTO" }, { "HermandadID": 33, "Nombre": "Caído", "IglesiaNombre": "Convento de San José (San Cayetano)", "IglesiaDireccion": "Cuesta de San Cayetano", "IglesiaLatitud": 37.89280067218521, "IglesiaLongitud": -4.774757899475162, "Activo": true, "LogotipoDocumentoID": 461, "LogotipoUrl": "Home/LogotipoHermandad/33", "MiniaturaUrl": "Home/MiniaturaHermandad/33", "Tags": "JUEVESSANTO" }, { "HermandadID": 34, "Nombre": "Sagrada Cena", "IglesiaNombre": "Parroquia del beato Álvaro de Córdoba", "IglesiaDireccion": "Av. Guerrita", "IglesiaLatitud": 37.87681058741905, "IglesiaLongitud": -4.798086295814528, "Activo": true, "LogotipoDocumentoID": 462, "LogotipoUrl": "Home/LogotipoHermandad/34", "MiniaturaUrl": "Home/MiniaturaHermandad/34", "Tags": "JUEVESSANTO" }, { "HermandadID": 35, "Nombre": "Angustias", "IglesiaNombre": "Iglesia conventual de San Agustín", "IglesiaDireccion": "Plaza de San Agustín", "IglesiaLatitud": 37.88926147231055, "IglesiaLongitud": -4.771913037681543, "Activo": true, "LogotipoDocumentoID": 463, "LogotipoUrl": "Home/LogotipoHermandad/35", "MiniaturaUrl": "Home/MiniaturaHermandad/35", "Tags": "JUEVESSANTO" }, { "HermandadID": 36, "Nombre": "Cristo de Gracia", "IglesiaNombre": "Parroquia de Nuestra Señora de Gracia (PP. Trinitarios)", "IglesiaDireccion": "Plaza de Capuchinos", "IglesiaLatitud": 37.88828119804551, "IglesiaLongitud": -4.777466543369314, "Activo": true, "LogotipoDocumentoID": 464, "LogotipoUrl": "Home/LogotipoHermandad/36", "MiniaturaUrl": "Home/MiniaturaHermandad/36", "Tags": "JUEVESSANTO" }, { "HermandadID": 37, "Nombre": "Buena Muerte", "IglesiaNombre": "Real Colegiata de San Hipólito", "IglesiaDireccion": "Calle Don Alonso Aguilar 4", "IglesiaLatitud": 37.88584145394546, "IglesiaLongitud": -4.782928338623037, "Activo": true, "LogotipoDocumentoID": 465, "LogotipoUrl": "Home/LogotipoHermandad/37", "MiniaturaUrl": "Home/MiniaturaHermandad/37", "Tags": "JUEVESSANTO,VIERNESSANTO" }, { "HermandadID": 38, "Nombre": "Soledad", "IglesiaNombre": "Parroquia de Santiago Apóstol", "IglesiaDireccion": "Calle Claustro, 1, 14002 Córdoba, España ", "IglesiaLatitud": 37.88177, "IglesiaLongitud": -4.76922, "Activo": true, "LogotipoDocumentoID": 466, "LogotipoUrl": "Home/LogotipoHermandad/38", "MiniaturaUrl": "Home/MiniaturaHermandad/38", "Tags": "VIERNESSANTO" }, { "HermandadID": 39, "Nombre": "Expiración", "IglesiaNombre": "Real Iglesia de San Pablo", "IglesiaDireccion": "Calle Capitulares", "IglesiaLatitud": 37.88532830124525, "IglesiaLongitud": -4.775558729858403, "Activo": true, "LogotipoDocumentoID": 467, "LogotipoUrl": "Home/LogotipoHermandad/39", "MiniaturaUrl": "Home/MiniaturaHermandad/39", "Tags": "VIERNESSANTO" }, { "HermandadID": 40, "Nombre": "Descendimiento", "IglesiaNombre": "Parroquia de San José y Espíritu Santo", "IglesiaDireccion": "Avenida de la Diputación", "IglesiaLatitud": 37.87472830985427, "IglesiaLongitud": -4.774636516227702, "Activo": true, "LogotipoDocumentoID": 468, "LogotipoUrl": "Home/LogotipoHermandad/40", "MiniaturaUrl": "Home/MiniaturaHermandad/40", "Tags": "VIERNESSANTO" }, { "HermandadID": 41, "Nombre": "Dolores", "IglesiaNombre": "Iglesia Hospital de San Jacinto", "IglesiaDireccion": "Plaza de Capuchinos", "IglesiaLatitud": 37.887972355392485, "IglesiaLongitud": -4.77726388595579, "Activo": true, "LogotipoDocumentoID": 469, "LogotipoUrl": "Home/LogotipoHermandad/41", "MiniaturaUrl": "Home/MiniaturaHermandad/41", "Tags": "VIERNESSANTO" }, { "HermandadID": 42, "Nombre": "Santo Sepulcro", "IglesiaNombre": "Parroquia del Salvador y Santo Domingo de Silos (Compañía)", "IglesiaDireccion": "Plaza de la Compañía", "IglesiaLatitud": 37.88370753656254, "IglesiaLongitud": -4.778612541389521, "Activo": true, "LogotipoDocumentoID": 470, "LogotipoUrl": "Home/LogotipoHermandad/42", "MiniaturaUrl": "Home/MiniaturaHermandad/42", "Tags": "VIERNESSANTO" }, { "HermandadID": 44, "Nombre": "Resucitado", "IglesiaNombre": "Parroquia de Santa Marina de Aguas Santas", "IglesiaDireccion": "Calle Moriscos, 2, 14001 Córdoba, España", "IglesiaLatitud": 37.88995, "IglesiaLongitud": -4.77478, "Activo": true, "LogotipoDocumentoID": 471, "LogotipoUrl": "Home/LogotipoHermandad/44", "MiniaturaUrl": "Home/MiniaturaHermandad/44", "Tags": "DOMINGORESURRECCION" }, { "HermandadID": 45, "Nombre": "Vía Crucis Hdad. Caridad", "IglesiaNombre": "Parroquia de San Francisco y San Eulogio", "IglesiaDireccion": "Calle Compás de San Francisco 3", "IglesiaLatitud": 37.881627486165804, "IglesiaLongitud": -4.775599423912013, "Activo": true, "LogotipoDocumentoID": 474, "LogotipoUrl": "Home/LogotipoHermandad/45", "MiniaturaUrl": "Home/MiniaturaHermandad/45", "Tags": "VIERNESSANTO" }], "Patrocinadores": [{ "EmpresaID": 12, "Nombre": "Cabildo Catedral de Córdoba", "Direccion": "Calle Magistral González Francés 21", "Localidad": "Córdoba", "CodigoPostal": "14003", "Provincia": "Córdoba", "Latitud": 37.87898116778553, "Longitud": -4.778582040336573, "Telefono": "957613044", "Email": "informacion@cabildocatedraldecordoba.es", "Web": "https://cabildocatedraldecordoba.es/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 504, "BannerDocumentoID": 505, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/12", "BannerUrl": "/Home/BannerEmpresa/12", "Tags": "", "Activo": true }, { "EmpresaID": 8, "Nombre": "Fundación Cajasur", "Direccion": "Avenida Ronda de los Tejares 802", "Localidad": "Córdoba", "CodigoPostal": "14001", "Provincia": "Córdoba", "Latitud": 37.88802483266895, "Longitud": -4.7819991746215464, "Telefono": "957 214 333", "Email": "info@fundacioncajasur.org", "Web": "", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 801, "BannerDocumentoID": 803, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/8", "BannerUrl": "/Home/BannerEmpresa/8", "Tags": "", "Activo": true }, { "EmpresaID": 13, "Nombre": "Atico 07", "Direccion": "Calle Vázquez Aroca 6", "Localidad": "Córdoba", "CodigoPostal": "14005", "Provincia": "Córdoba", "Latitud": 37.88371060110921, "Longitud": -4.790378395584071, "Telefono": "957 23 78 84", "Email": "administracion@atico07.es", "Web": "http://www.atico07.es", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 507, "BannerDocumentoID": 517, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/13", "BannerUrl": "/Home/BannerEmpresa/13", "Tags": "", "Activo": true }, { "EmpresaID": 11, "Nombre": "Enclave Social", "Direccion": "Plaza de las Tendillas 1", "Localidad": "Córdoba", "CodigoPostal": "14002", "Provincia": "Córdoba", "Latitud": 37.88446, "Longitud": -4.779553, "Telefono": "957474598", "Email": "", "Web": "http://www.enclavesocial.org", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 501, "BannerDocumentoID": 503, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/11", "BannerUrl": "/Home/BannerEmpresa/11", "Tags": "", "Activo": true }, { "EmpresaID": 7, "Nombre": "El Corte Inglés", "Direccion": "Avenida Ronda de los Tejares 30", "Localidad": "Córdoba", "CodigoPostal": "14008", "Provincia": "Córdoba", "Latitud": 37.88783008379686, "Longitud": -4.782878939178431, "Telefono": "957 22 28 81", "Email": "", "Web": "https://www.elcorteingles.es/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 493, "BannerDocumentoID": 494, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/7", "BannerUrl": "/Home/BannerEmpresa/7", "Tags": "", "Activo": true }, { "EmpresaID": 14, "Nombre": "PROTVISE VIGILANCIA S.A.", "Direccion": "Avenida de Cervantes 10", "Localidad": "Córdoba", "CodigoPostal": "14008", "Provincia": "Córdoba", "Latitud": 37.888215347371556, "Longitud": -4.784799400833094, "Telefono": "957491324", "Email": "protvise@hotmail.com", "Web": "http://www.protvisevigilancia.com", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 1209, "BannerDocumentoID": 1213, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/14", "BannerUrl": "/Home/BannerEmpresa/14", "Tags": "", "Activo": true }, { "EmpresaID": 26, "Nombre": "Modicar", "Direccion": "", "Localidad": "", "CodigoPostal": "", "Provincia": "", "Latitud": null, "Longitud": null, "Telefono": "", "Email": "", "Web": "", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 1210, "BannerDocumentoID": 1214, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/26", "BannerUrl": "/Home/BannerEmpresa/26", "Tags": "", "Activo": true }, { "EmpresaID": 23, "Nombre": "Igesur", "Direccion": "", "Localidad": "", "CodigoPostal": "", "Provincia": "", "Latitud": null, "Longitud": null, "Telefono": "957160735", "Email": "tecnico@igesur.com", "Web": "https://www.igesur.com/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": null, "BannerDocumentoID": 821, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/23", "BannerUrl": "/Home/BannerEmpresa/23", "Tags": "", "Activo": true }, { "EmpresaID": 20, "Nombre": "Teclicor", "Direccion": "Calle Teresa de Calcuta 1", "Localidad": "Córdoba", "CodigoPostal": "14011", "Provincia": "Córdoba", "Latitud": 37.8951331, "Longitud": -4.796227400000021, "Telefono": "957767456", "Email": "teclicor@teclicor.es", "Web": "", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": null, "BannerDocumentoID": 817, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/20", "BannerUrl": "/Home/BannerEmpresa/20", "Tags": "", "Activo": true }, { "EmpresaID": 19, "Nombre": "Fundación Cajasol", "Direccion": "Avda. Ronda de los Tejares, 32", "Localidad": "Córdoba", "CodigoPostal": "14008", "Provincia": "Córdoba", "Latitud": 37.88446, "Longitud": -4.779553, "Telefono": "957 748 046", "Email": "fundacioncordoba@cajasol.com", "Web": "https://fundacioncajasol.com/tag/cordoba/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 804, "BannerDocumentoID": 805, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/19", "BannerUrl": "/Home/BannerEmpresa/19", "Tags": "", "Activo": true }, { "EmpresaID": 25, "Nombre": "Gema León", "Direccion": "Calle Isla Menorca", "Localidad": "Córdoba", "CodigoPostal": "14011", "Provincia": "Córdoba", "Latitud": 37.8925698, "Longitud": -4.799100400000043, "Telefono": "957 782 479", "Email": "", "Web": "http://www.fisiogemaleon.com/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": null, "BannerDocumentoID": 1217, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/25", "BannerUrl": "/Home/BannerEmpresa/25", "Tags": "", "Activo": true }, { "EmpresaID": 21, "Nombre": "Acero 3", "Direccion": "", "Localidad": "", "CodigoPostal": "", "Provincia": "", "Latitud": null, "Longitud": null, "Telefono": "", "Email": "", "Web": "http://www.acerotres.es/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 818, "BannerDocumentoID": 828, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/21", "BannerUrl": "/Home/BannerEmpresa/21", "Tags": "", "Activo": true }, { "EmpresaID": 24, "Nombre": "Enerytel", "Direccion": "Calle Estocolmo 8", "Localidad": "Córdoba", "CodigoPostal": "14014", "Provincia": "Córdoba", "Latitud": 37.8999068, "Longitud": -4.734094599999935, "Telefono": "616418660", "Email": "info@enerytel.es", "Web": "http://enerytel.es/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": null, "BannerDocumentoID": 822, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/24", "BannerUrl": "/Home/BannerEmpresa/24", "Tags": "", "Activo": true }, { "EmpresaID": 22, "Nombre": "Diperplac", "Direccion": "Calle Letonia 99", "Localidad": "Córdoba", "CodigoPostal": "14014", "Provincia": "Córdoba", "Latitud": 37.8982105, "Longitud": -4.731547599999999, "Telefono": "957434099", "Email": "info@diperplac.com", "Web": "http://www.diperplac.com/web/seccion/pagina/contenido/plantillas/index.php?s=2#", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": null, "BannerDocumentoID": 820, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/22", "BannerUrl": "/Home/BannerEmpresa/22", "Tags": "", "Activo": true }, { "EmpresaID": 15, "Nombre": "Tressis", "Direccion": "Avenida Ronda de los Tejares 32-34", "Localidad": "Córdoba", "CodigoPostal": "14008", "Provincia": "Córdoba", "Latitud": 37.88723736666895, "Longitud": -4.7832973637847545, "Telefono": "957474617", "Email": "", "Web": "", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 524, "BannerDocumentoID": 1218, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/15", "BannerUrl": "/Home/BannerEmpresa/15", "Tags": "", "Activo": true }, { "EmpresaID": 9, "Nombre": "Ayuntamiento de Córdoba", "Direccion": "Calle Capitulares 1", "Localidad": "Córdoba", "CodigoPostal": "14002", "Provincia": "Córdoba", "Latitud": 37.88517128680822, "Longitud": -4.776135865714991, "Telefono": "957499900", "Email": "", "Web": "https://www.cordoba.es/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 497, "BannerDocumentoID": 498, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/9", "BannerUrl": "/Home/BannerEmpresa/9", "Tags": "", "Activo": true }, { "EmpresaID": 17, "Nombre": "Fundación Caja Rural del Sur", "Direccion": "Avenida Ronda de los Tejares 36", "Localidad": "Córdoba", "CodigoPostal": "14001", "Provincia": "Córdoba", "Latitud": 37.8869729, "Longitud": -4.784000999999989, "Telefono": "957 76 74 42", "Email": "", "Web": "http://fundacioncajaruraldelsur.com/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 531, "BannerDocumentoID": 532, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/17", "BannerUrl": "/Home/BannerEmpresa/17", "Tags": "", "Activo": true }, { "EmpresaID": 16, "Nombre": "Netherman", "Direccion": "", "Localidad": "", "CodigoPostal": "", "Provincia": "", "Latitud": null, "Longitud": null, "Telefono": "670872701", "Email": "info@netherman.es", "Web": "http://www.netherman.es", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": null, "BannerDocumentoID": 528, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/16", "BannerUrl": "/Home/BannerEmpresa/16", "Tags": "", "Activo": true }, { "EmpresaID": 10, "Nombre": "Diputación de Córdoba", "Direccion": "Plaza de Colón 15", "Localidad": "Córdoba", "CodigoPostal": "14001", "Provincia": "Córdoba", "Latitud": 37.89043798247788, "Longitud": -4.7801538148193, "Telefono": "957211100", "Email": "", "Web": "http://www.dipucordoba.es/", "Facebook": "", "Twitter": "", "LogotipoDocumentoID": 499, "BannerDocumentoID": 527, "Descripcion": "", "LogotipoUrl": "Home/LogotipoEmpresa/10", "BannerUrl": "/Home/BannerEmpresa/10", "Tags": "", "Activo": true }] };

(function () {
    var mapa;

    /** Opciones por defecto */
    var _opciones = {
        url: "",
        latitud: 37.892394,
        longitud: -4.780709,
        zoom: 14,
        tipoMapa: "G_NORMAL_MAP",
        animacionMarcador: "DROP",
        refresco: 1.5, // Minutos
        polilineaGrosor: 2,
        refrescoPosicionUsuario: 0.3, // Minutos
        marcadorCola: true,
        trazoRecorrido: true,
        filtroInicial: "",
        bannersHabilitados: true,
        periodoBanner: 5000,
        marcadoresPatrocinadores: true
    };

    /** Textos por defecto */
    var _textos = {
        errorCapaMapaNoEncontrada: "Capa del mapa no encontrada.",
        salida: "Salida",
        carreraOficial: "Carrera Oficial",
        inicioCarreraOficial: "Inicio de la carrera oficial",
        finCarreraOficial: "Fin de la carrera oficial",
        fin: "Fin",
        cruzDeGuia: "Cruz de guía",
        finDeCortejo: "Fin de cortejo",
        posicionCruzGuia: "Posición cruz de guía",
        posicionCola: "Posición cola",
        distanciaRecorrida: "Distancia recorrida",
        velocidadMedia: "Velocidad media",
        iglesiaNombre: "Iglesia",
        iglesiaDireccion: "Dirección",
        patrocinadorDireccion: "Dirección",
        patrocinadorTelefono: "Teléfono",
        patrocinadorWeb: "Web",
        patrocinadorFacebook: "Facebook",
        patrocinadorTwitter: "Twitter",
        filtroTitulo: "Filtrar hermandades",
        hermandadesTodas: "Todas las hermandades",
        domingoRamos: "Domingo de Ramos",
        lunesSanto: "Lunes Santo",
        martesSanto: "Martes Santo",
        miercolesSanto: "Miércoles Santo",
        juevesSanto: "Jueves Santo",
        viernesSanto: "Viernes Santo",
        sabadoSanto: "Sábado Santo",
        domingoResurreccion: "Domingo de Resurrección",
        atras: "Atrás"
    };

    var carreraOficial = [
        { lat: 37.8776482, lng: -4.7790434 },
        { lat: 37.8777973, lng: -4.7791667 },
        { lat: 37.8780895, lng: -4.7794765 },
        { lat: 37.8779063, lng: -4.7797112 },
        { lat: 37.878153, lng: -4.7798681 },
        { lat: 37.8783389, lng: -4.7799642 },
        { lat: 37.8793841, lng: -4.7806527 },
        { lat: 37.8795461, lng: -4.780717 },
        { lat: 37.8795546, lng: -4.7806071 },
        { lat: 37.8796487, lng: -4.7802953 },
        { lat: 37.8794963, lng: -4.7801927 },
        { lat: 37.8791162, lng: -4.7799258 },
        { lat: 37.8791745, lng: -4.7799667 },
        { lat: 37.8795059, lng: -4.779211 },
        { lat: 37.8795789, lng: -4.7792606 },
        { lat: 37.8796604, lng: -4.7790956 },
        { lat: 37.878993, lng: -4.7785994 },
        { lat: 37.878605, lng: -4.7783332 }
    ];

    /** Div del mapa. */
    var mapaDiv = $("#mapa");
    //  Si no está en el DOM, salir de la closure.
    if (!mapaDiv.length) {
        console.error(_textos.errorCapaMapaNoEncontrada);
        return;
    }

    // Combinar las opciones por defecto con las que vienen en el atributo data-opciones del
    // div del mapa, en formato JSON. Lo mismo para los textos, con el atributo data-textos.
    var opciones = $.extend({}, _opciones, mapaDiv.data("opciones"));
    var textos = $.extend({}, _textos, mapaDiv.data("textos"));
    var timerPosicionUsuario, marcadorUsuario;

    var arrMenu = [{
        title: textos.filtroTitulo,
        id: 'menuID',
        icon: 'fa fa-reorder',
        items: [{
            name: textos.hermandadesTodas,
            id: 'TODAS',
            link: '#'
        }, {
            name: textos.domingoRamos,
            id: "DOMINGORAMOS",
            link: '#',
            items: [{
                title: textos.domingoRamos,
                items: []
            }]
        }, {
            name: textos.lunesSanto,
            id: "LUNESSANTO",
            link: '#',
            items: [{
                title: textos.lunesSanto,
                items: []
            }]
        }, {
            name: textos.martesSanto,
            id: "MARTESSANTO",
            link: '#',
            items: [{
                title: textos.martesSanto,
                items: []
            }]
        }, {
            name: textos.miercolesSanto,
            id: "MIERCOLESSANTO",
            link: '#',
            items: [{
                title: textos.miercolesSanto,
                items: []
            }]
        }, {
            name: textos.juevesSanto,
            id: "JUEVESSANTO",
            link: '#',
            items: [{
                title: textos.juevesSanto,
                items: []
            }]
        }, {
            name: textos.viernesSanto,
            id: "VIERNESSANTO",
            link: '#',
            items: [{
                title: textos.viernesSanto,
                items: []
            }]
        },
        /*{
                           name: textos.sabadoSanto,
                           id: "SABADOSANTO",
                           link: '#',
                           items: [{
                               title: textos.sabadoSanto,
                               items: []
                           }]
                       },*/
        {
            name: textos.domingoResurreccion,
            id: "DOMINGORESURRECCION",
            link: '#',
            items: [{
                title: textos.domingoResurreccion,
                items: []
            }]
        }
        ]
    }];
    var menuHabilitado = false;
    var ultimoMenu = "",
        textoSubmenu = "";
    var filtroActual = (opciones.filtroInicial && opciones.filtroInicial.length) ?
        opciones.filtroInicial :
        "TODAS";

    var tagDiaSeleccionado;
    var filtrosplit = filtroActual.split("_");
    if (filtrosplit.length > 1) {
        tagDiaSeleccionado = filtrosplit[1];
    } else {
        tagDiaSeleccionado = "";
    }

    var textoBoton;
    if (filtroActual === "TODAS") {
        textoBoton = textos.hermandadesTodas;
    } else if (filtroActual === "TODAS_DOMINGORAMOS") {
        textoBoton = textos.domingoRamos;
    } else if (filtroActual === "TODAS_LUNESSANTO") {
        textoBoton = textos.lunesSanto;
    } else if (filtroActual === "TODAS_MARTESSANTO") {
        textoBoton = textos.martesSanto;
    } else if (filtroActual === "TODAS_MIERCOLESSANTO") {
        textoBoton = textos.miercolesSanto;
    } else if (filtroActual === "TODAS_JUEVESSANTO") {
        textoBoton = textos.juevesSanto;
    } else if (filtroActual === "TODAS_VIERNESSANTO") {
        textoBoton = textos.viernesSanto;
    } else if (filtroActual === "TODAS_SABADOSANTO") {
        textoBoton = textos.sabadoSanto;
    } else if (filtroActual === "TODAS_DOMINGORESURRECCION") {
        textoBoton = textos.domingoResurreccion;
    }
    $("#filtroActual").text(textoBoton);

    var botonMenu = $("#BotonMenu");
    var menu = $("#menu");

    if (menu) {
        menu.multilevelpushmenu({
            menu: arrMenu,
            menuWidth: '80%',
            menuHeight: '100%',
            fullCollapse: true,
            collapsed: true,
            direction: 'rtl',
            backText: textos.atras,
            onGroupItemClick: cargarSubmenu,
            onItemClick: filtrarPorGrupo
        });

        // Si hay un filtro por
        if (filtroActual !== "TODAS") {
            ultimoMenu = $('#menu').multilevelpushmenu('findmenusbytitle', textoBoton);
        }

        $(window).resize(function () {
            menu.multilevelpushmenu('redraw');
        });

    } else {
        botonMenu.hide();
    }

    /** Catálogo de iconos que se utilizan en el mapa. */
    var iconos = {
        'iglesia.a': L.icon({
            iconUrl: '/img/RutasMapa/church.a.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'iglesia.b': L.icon({
            iconUrl: '/img/RutasMapa/church.b.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'info.a': L.icon({
            iconUrl: '/img/RutasMapa/info.a.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'info.b': L.icon({
            iconUrl: '/img/RutasMapa/info.b.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'cruz1': L.icon({
            iconUrl: '/img/RutasMapa/cruz.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'cruz2': L.icon({
            iconUrl: '/img/RutasMapa/RutasMapa/cruz2.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'inicioRuta': L.icon({
            iconUrl: 'http://maps.google.com/mapfiles/kml/paddle/red-diamond-lv.png'
        }),
        'finRuta': L.icon({
            iconUrl: 'http://maps.google.com/mapfiles/kml/paddle/red-square-lv.png'
        }),
        'carreraOficial': L.icon({
            iconUrl: '/img/RutasMapa/corona.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'corona1': L.icon({
            iconUrl: '/img/RutasMapa/corona.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'corona2': L.icon({
            iconUrl: '/img/RutasMapa/crown.2.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'corona3': L.icon({
            iconUrl: '/img/RutasMapa/crown.3.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'conoraEspinas': L.icon({
            iconUrl: '/img/RutasMapa/crown-of-thorns.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        }),
        'usuario': L.icon({
            iconUrl: '/img/RutasMapa/usuario.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        })
    };

    /** Lista de colores para las rutas. */
    var coloresRutas = ["#055CB3", "#B62E2E", "#30BCF8", "#068404", "#FF7F2A", "#6F72C1",
        "#C26B42", "#800E0E", "#3CCC78"
    ];

    /** Contador cíclico para el color de la ruta actual. */
    var colorActualRuta = 0;

    /** Lista de marcadores del mapa. */
    var marcadores = {};

    /** Marcadores de hermandades clasificados por día de la semana santa */
    var hermandadesPorDia = {};

    /** Lista de rutas del mapa. */
    var rutas = {};

    /** InfoWindow abierta. Cuando se abre un globo se asigna a este identificador. */
    infoWindowAbierta = null;


    // Inicializar el mapa.
    mapa = L.map('mapa').setView([51.505, -0.09], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mapa);
    
    // Cerrar los globos abiertos al hacer click en cualquier parte del mapa.
    // mapa.addListener('click', function() {
    //     if (infoWindowAbierta) {
    //         infoWindowAbierta.close();
    //     }
    // });

    var bannerPatrocinadores = $("#banners");
    var patrocinadores = [];
    var intervaloPatrocinadores = null;
    var patrocinadorActualIndice = null;

    if (mapaDiv.length && !opciones.bannersHabilitados) {
        bannerPatrocinadores.hide();
        mapaDiv.css({ height: "100%" });
    }

    /** Solicita los datos de hermandades, patrocinadores y rutas al servidor.
     * En caso de éxito, invoca a la función actualizarMapa.
     * En caso de error invoca a la función error.
     */
    function cargarDatos() {
        actualizarMapa(datosSim);
        //$.ajax({
        //    url: opciones.url,
        //    method: "POST",
        //    data: { ps: getParameterByName("ps") },
        //    success: actualizarMapa,
        //    error: error
        //});
    }

    timerPosicionUsuario = setInterval(actualizarPosicionUsuario,
        opciones.refrescoPosicionUsuario * 60000);

    /** Obtiene las coordenadas del usuario y llama al callback.
     * En caso de obtener las coordenadas correctamente, invoca a posicionUsuario.
     * Si la obtención falla invoca a cancelarTimer.
     */
    function actualizarPosicionUsuario() {
        navigator.geolocation.getCurrentPosition(posicionUsuario, cancelarTimer);
    }

    /** Actualiza las coordenadas del marcador que indica la ubicación del usuario.
     * @param {object} posicionUsuario Objeto con las coordenadas del usuario y la precisión.
     */
    function posicionUsuario(posicionUsuario) {
        if (posicionUsuario) {
            var latitud = posicionUsuario.coords.latitude;
            var longitud = posicionUsuario.coords.longitude;

            if (!marcadorUsuario) {
                var icono = iconos.usuario;
                marcadorUsuario = crearMarcador(latitud, longitud, "", icono, 0);
            }
            //marcadorUsuario.setPosition([latitud, longitud]);
        }
    }

    /** Cancela el ciclo de actualización de la posición del usuario. */
    function cancelarTimer() {
        clearInterval(timerPosicionUsuario);
        delete timerPosicionUsuario;
    }

    function habilitarMenu() {
        botonMenu.on("click", function () {
            //console.log("BotonMenu pulsado");
            if (ultimoMenu.length) {
                // cargarSubmenu
                cargarSubmenu(ultimoMenu);
                menu.multilevelpushmenu("expand", ultimoMenu);
            } else {
                menu.multilevelpushmenu("expand");
            }
        });
        menuHabilitado = true;
    }

    /** Limpia el mapa de marcadores y rutas y luego genera todos los marcadores y rutas del
     * objeto data. Se usa como callback del caso de éxito de cargarDatos.
     * @param {object} data Datos de marcadores y rutas.
     */
    function actualizarMapa(data) {


        // Si el servicio indica que hay que redirigir...
        if (data && data.redirectUrl) {
            window.location = data.redirectUrl;
            return;
        }

        if (!menuHabilitado) {
            habilitarMenu();
        }

        // Reiniciar el ciclo de colores.
        colorActualRuta = 0;

        quitarMarcadores();

        for (var i = 0; i < data.Patrocinadores.length; i++) {
            // Pintar cada marcador de patrocinador si la configuración lo indica.
            if (opciones.marcadoresPatrocinadores) {
                nuevoMarcadorPatrocinador(data.Patrocinadores[i]);
            }

            // Clasificar los patrocinadores
            if (!patrocinadores[data.Patrocinadores[i].EmpresaID]) {
                patrocinadores.push(data.Patrocinadores[i]);
            }
        }

        if (patrocinadores.length && opciones.bannersHabilitados) {
            if (!intervaloPatrocinadores) {
                iniciarCicloPatrocinadores();
            }
            bannerPatrocinadores.show();
        } else {
            clearInterval(intervaloPatrocinadores);
            patrocinadorActualIndice = null;
            bannerPatrocinadores.empty();
            bannerPatrocinadores.hide();
        }

        // Pintar cada ruta.
        for (var i = 0; i < data.Rutas.length; i++) {
            var hermandadRuta = data.Hermandades.find(function (h) {
                return h.HermandadID == data.Rutas[i].HermandadID;
            });
            nuevaRuta(data.Rutas[i], hermandadRuta);
        }

        if (data.Rutas.length) {
            pintarCarreraOficial();
        }

        // Pintar cada marcador de hermandad que no tenga una ruta activa.
        for (var i = 0; i < data.Hermandades.length; i++) {
            // Sólo crear los marcadores de la hermandad si no tiene una ruta activa.
            if (!rutas[data.Hermandades[i].HermandadID]) {
                nuevoMarcadorHermandad(data.Hermandades[i]);
            }
        }

        filtrarPorTag(filtroActual);
        centrarMarcadores();
    }

    function iniciarCicloPatrocinadores() {
        actualizarBanner();
        intervaloPatrocinadores = setInterval(actualizarBanner, opciones.periodoBanner);
    }

    /** Determina cuál es el siguiente banner a mostrar y actualiza el banner */
    function actualizarBanner() {

        if (patrocinadorActualIndice != null && patrocinadorActualIndice >= 0) {
            patrocinadorActualIndice = (1 + patrocinadorActualIndice) % patrocinadores.length;
        } else {
            patrocinadorActualIndice = 0;
        }
        establecerBanner(patrocinadores[patrocinadorActualIndice]);
    }

    function establecerBanner(patrocinador) {
        bannerPatrocinadores.empty();
        console.log("Mostrando patrocinador: " + patrocinador.EmpresaID);
        bannerPatrocinadores.append("<img src='" + patrocinador.BannerUrl + "'/>");
    }

    /** Escribe por consola los datos de error, si ocurre un error en cargarDatos */
    function error(requestObject, error, errorThrown) {
        console.error(requestObject, error, errorThrown);
    }

    /** Elimina del mapa todos los marcadores y rutas. */
    function quitarMarcadores() {

        console.log("Antes de Quitar marcadores: ", marcadores);
        for (var idm in marcadores) {
            marcadores[idm].marcador.remove();
            delete marcadores[idm];
        }

        console.log("Tras Quitar marcadores: ", marcadores);

        for (var idr in rutas) {
            if (rutas[idr].puntos && rutas[idr].puntos.length) {
                rutas[idr].puntos.forEach(function (p) {
                    // console.log(p);
                    p.remove();
                });

                delete rutas[idr];
            }
        }
        for (var tag in hermandadesPorDia) {
            var hermandadesDia = hermandadesPorDia[tag];
            for (var hermandadId in hermandadesDia) {
                var hermandadActual = hermandadesDia[hermandadId];
                while (hermandadActual.elementosMapa.length) {
                    hermandadActual.elementosMapa.pop();
                }
            }
        }
    }

    function pintarCarreraOficial() {
        var inicioCO = carreraOficial[0];
        var marcadorInicio = crearMarcador(inicioCO.lat, inicioCO.lng,
            textos.inicioCarreraOficial, iconos.conoraEspinas, 1);
        /*var infoWindowInicio = */
        // crearInfoWindow(textos.inicioCarreraOficial,
        //     inicioCO.lat, inicioCO.lng, -21, 0, marcadorInicio);
        marcadores.co1 = { marcador: marcadorInicio, enMapa: true /*, infoWindow: infoWindowInicio*/ };

        var finCO = carreraOficial.slice(-1)[0];
        var marcadorFin = crearMarcador(finCO.lat, finCO.lng,
            textos.finCarreraOficial, iconos.conoraEspinas, 1);
        /*var infoWindowFin =*/
        // crearInfoWindow(textos.finCarreraOficial,
        //     finCO.lat, finCO.lng, -21, 0, marcadorFin);
        marcadores.co1 = { marcador: marcadorFin, enMapa: true /*, infoWindow: infoWindowFin*/ };

        // Trazo de la carrera oficial
        var polyline = L.polyline(carreraOficial, { color: '#F57C00' });
        // new g.maps.Polyline({
        //     path: carreraOficial,
        //     geodesic: true,
        //     zindex: 0,
        //     strokeColor: "#F57C00",
        //     strokeOpacity: 1.0,
        //     strokeWeight: opciones.polilineaGrosor,
        //     map: mapa,
        //     title: textos.carreraOficial,
        //     clickable: false
        // });

        // Click en el trazo de la ruta abre el globo en la posición del marcador de cabeza.
        rutas.carreraOficial = { polyline };
        polyline.addTo(mapa);
    }

    /** Genera una nueva ruta en el mapa, con su polilínea, marcadores, infoWindow y eventos.
     * @param {object} ruta Datos de la ruta.
     * @param {object} hermandad Datos de la hermandad.
     */
    function nuevaRuta(ruta, hermandad) {

        rutas[ruta.HermandadID] = { ruta: ruta, puntos: [] };
        // Trazo de recorrido: desde la cabeza hasta la cola si hay dato de cola.
        // Desde la cabeza hasta el origen si no hay cola.
        // Sólo se dibuja si la opción está activada.
        if (opciones.trazoRecorrido) {

            // La polilínea de ruta se dibuja desde al cola hasta la cabeza.
            // Si hay posición de cola, ese es el primer punto. Luego se añaden todos los puntos de
            // cabeza en el orden en que vienen. El último coincidirá siempre con la posición 
            // actual de cabeza, y el marcador de cruz de guía.
            puntosPolilinea = [];

            var color = coloresRutas[(colorActualRuta++) % coloresRutas.length];
            ruta.Posiciones.forEach(function (p) {
                if (p.Latitud !== ruta.CabezaLatitud || p.Longitud !== ruta.CabezaLongitud) {

                    var posActual = { lat: p.Latitud, lng: p.Longitud };
                    var circulo = new google.maps.Marker({
                        position: posActual,
                        map: mapa,
                        //optimized: false, // para que funcione el zindex
                        zIndex: 1,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillOpacity: 1,
                            fillColor: color,
                            strokeOpacity: 1.0,
                            strokeColor: color,
                            strokeWeight: 3.0,
                            scale: 5 //pixels
                        }
                    });

                    rutas[ruta.HermandadID].puntos.push(circulo)
                    //clasificarMarcadorHermandad(hermandad, circulo);
                }
            });

            if (ruta.ColaLatitud && ruta.ColaLongitud) {
                var cola = new google.maps.Marker({
                    position: new google.maps.LatLng(ruta.ColaLatitud, ruta.ColaLongitud),
                    map: mapa,
                    //optimized: false, // para que funcione el zindex
                    zIndex: 1,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillOpacity: 1,
                        fillColor: color,
                        strokeOpacity: 1.0,
                        strokeColor: color,
                        strokeWeight: 3.0,
                        scale: 5 //pixels
                    }
                });

                rutas[ruta.HermandadID].puntos.push(cola)
                clasificarMarcadorHermandad(hermandad, cola);
            }

            clasificarMarcadorHermandad(hermandad, ruta);
        }

        // Marcador de cabeza: aparece en las coordenadas del punto de ruta más reciente.
        var marcadorCabeza = crearMarcadorCabezaRuta(ruta).bindPopup(contentInfoWindowRuta(ruta, hermandad));
        /*var infoWindowCabeza = */
        // crearInfoWindow(contentInfoWindowRuta(ruta, hermandad),
        //     ruta.CabezaLatitud, ruta.CabezaLongitud, -36, 0, marcadorCabeza);
        marcadores["rcab" + ruta.HermandadID] = { marcador: marcadorCabeza, ruta, enMapa: true /*, infoWindow: infoWindowCabeza*/ };

        // No clasificamos las rutas para que no se vean afectadas por el filtro.
        //clasificarMarcadorHermandad(hermandad, marcadorCabeza);

        // Marcador de cola: sólo si la opción está activada.
        if (opciones.marcadorCola) {
            //Si hay coordenadas de cola, dibujar un círculo del mismo color que la ruta en esas
            //coordenadas
            if (ruta.ColaLatitud && ruta.ColaLongitud) {
                var marcadorCola = crearMarcadorColaRuta(ruta).bindPopup(contentInfoWindowCola(ruta, hermandad));
                marcadores["rcol" + ruta.HermandadID] = { marcador: marcadorCola, ruta, enMapa: true /*, infoWindow: infoWindowCola */ };

                // No clasificamos las rutas para que no se vean afectadas por el filtro.
                //clasificarMarcadorHermandad(hermandad, marcadorCola);
            }
        }
    }

    function crearMarcadorCabezaRuta(ruta) {
        //console.log("Creando marcador de cabeza de la ruta", ruta);
        return crearMarcador(ruta.CabezaLatitud, ruta.CabezaLongitud,
            ruta.CabezaDireccion, nuevoIconoCruz(ruta.HermandadID), 10);
        //console.log("creado marcador de cabeza de la ruta", ruta);
    }

    function crearMarcadorColaRuta(ruta) {
        //console.log("Creando marcador de cola de la ruta", ruta);
        return crearMarcador(ruta.ColaLatitud, ruta.ColaLongitud, ruta.ColaDireccion, nuevoIconoCorona(ruta.HermandadID), 5);
        //console.log("Creado marcador de cola de la ruta", ruta);
    }

    function nuevoIconoCruz(hermandadId) {
        var idHermandadStr = ("0000" + hermandadId.toString()).slice(-4);
        return L.icon({
            iconUrl: '/img/RutasMapa/cruz2.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        });
    }

    function nuevoIconoCorona(hermandadId) {
        var idHermandadStr = ("0000" + hermandadId.toString()).slice(-4);
        return L.icon({
            iconUrl: '/img/RutasMapa/crown.3.png',
            iconAnchor: [12, 12],
            iconSize: [24, 24],
            popupAnchor: [0, 0]
        });
    }

    function clasificarMarcadorHermandad(hermandad, marcador) {
        if (hermandad) {
            var hermandadId = hermandad.HermandadID;
            var tagsDia = hermandad.Tags.split(",");
            for (var i = 0; i < tagsDia.length; i++) {
                var tag = tagsDia[i].trim();
                if (!hermandadesPorDia[tag]) {
                    hermandadesPorDia[tag] = {};
                }
                if (!hermandadesPorDia[tag][hermandadId]) {
                    hermandadesPorDia[tag][hermandadId] = { hermandad: hermandad, elementosMapa: [] };
                }
                hermandadesPorDia[tag][hermandadId].elementosMapa.push(marcador);
            }
        }
    }

    /** Genera el HTML para el contenido del globo de una ruta.
     * @param {object} ruta Datos de la ruta.
     * @param {object} hermandad Datos de la hermandad que realiza la ruta.
     */
    function contentInfoWindowRuta(ruta, hermandad) {
        var content = "";
        if (hermandad) {
            content =
                "<div class='info-window-content' style='height: 275px; width: 300px;'>" +
                "<div class='col-izquierda'>" +
                "<img src='/" + hermandad.LogotipoUrl + "'/>" +
                "</div>" +
                "<div class='col-derecha'>" +
                "<h2>" + hermandad.Nombre + "</h2>" +
                "<h3>" + textos.cruzDeGuia + "</h3>" +
                "<dl>" +
                strContenidoRuta(ruta) +
                "</dl>" +
                "</div>" +
                "</div>";
        }

        var popup = L.popup()
            .setContent(content);

        return popup;
    }

    function contentInfoWindowCola(ruta, hermandad) {
        var content = "";
        if (hermandad) {
            content =
                "<div class='info-window-content' style='height: 275px; width: 300px;'>" +
                "<div class='col-izquierda'>" +
                "<img src='/" + hermandad.LogotipoUrl + "'/>" +
                "</div>" +
                "<div class='col-derecha'>" +
                "<h2>" + hermandad.Nombre + "</h2>" +
                "<h3>" + textos.finDeCortejo + "</h3>" +
                "<dl>" +
                strContenidoRuta(ruta) +
                "</dl>" +
                "</div>" +
                "</div>";
        }

        var popup = L.popup()
            .setContent(content);

        return popup;
    }

    /** Genera parte del HTML del contenido del globo de una ruta.
     * @param {object} ruta Datos de la ruta.car
     */
    function strContenidoRuta(ruta) {
        var resul = "";
        resul += itemInfoWindow(textos.salida, ruta.InicioDescripcion + " " + parseJsonDate(ruta.InicioFecha).toLocaleString());
        resul += itemInfoWindow(textos.carreraOficial, ruta.EntradaEnCarreraOficial);
        resul += itemInfoWindow(textos.fin, ruta.FinDescripcion + " " +
            (ruta.FinFecha && ruta.FinFecha.length ? parseJsonDate(ruta.FinFecha).toLocaleString() : ""));
        resul += itemInfoWindow(textos.distanciaRecorrida, .01 * Math.round(.1 * ruta.Distancia).toString().replace(".", ",") + " Km");
        resul += itemInfoWindow(textos.velocidadMedia, Math.round(ruta.Velocidad).toString() + " m/h");
        return resul;
    }

    /** Crea un marcador asociado al mapa.
     * @param {float} latitud Coordenadas del marcador: Latitud.
     * @param {float} longitud Coordenadas del marcador: Longitud.
     * @param {string} titulo Texto emergente del marcador.
     * @param {object} icono Icono para el marcador.
     */
    function crearMarcador(latitud, longitud, titulo, icono, zIndex) {
        var marcador = L.marker(
            [latitud, longitud], {
                icon: icono,
                draggable: false,
                title: titulo
            });

        if (latitud !== null && latitud !== 0 && longitud !== null && longitud !== 0) {
            marcador.addTo(mapa);
        }

        return marcador;
    }

    /** Crea un infoWindow asociado al mapa y registra el evento que cierra cualquier otra
     * infoWindow abierta y abre esta, al hacer click en el marcador asociado.
     * @param {string} contenido Contenido HTML de la infoWindow.
     * @param {float} latitud Coordenadas de la infoWindow: Latitud.
     * @param {float} longitud Coordenadas de la infoWindow: Longitud.
     * @param {int} offsetX Desplazamiento horizontal de la infoWindow.
     * @param {int} offsetY Desplazamiento vertical de la infoWindow.
     * @param {object} marcador Objeto correspondiente al marcador, instancia de la clase 
     * google.maps.Marker, al que se asociará el infoWindow.
     */
    function crearInfoWindow(contenido, latitud, longitud, offsetX, offsetY, marcador) {
        if (marcador) {
            // window.addListener(marcador, 'click', function() {
            //     if (infoWindowAbierta) {
            //         infoWindowAbierta.close();
            //     }

            //     var infoWindow = new g.maps.InfoWindow({
            //         content: contenido,
            //         position: [latitud, longitud],
            //         'pixelOffset': new g.maps.Size(offsetX, offsetY)
            //     });

            //     infoWindowAbierta = infoWindow;
            //     infoWindow.open(mapa, marcador);
            // });
        }
    }

    /** Crea un marcador de hermandad con su infowindow, y lo deja registrado en la lista de 
     * marcadores.
     * @param {object} hermandad Datos de la hermandad.
     */
    function nuevoMarcadorHermandad(hermandad) {
        var marcador = crearMarcador(hermandad.IglesiaLatitud, hermandad.IglesiaLongitud,
            hermandad.Nombre, iconos['iglesia.a'], 1).bindPopup(contentInfoWindowHermandad(hermandad));
        /*var infoWindow = */
        // crearInfoWindow(contentInfoWindowHermandad(hermandad),
        //     hermandad.Latitud, hermandad.Longitud, -53, 0, marcador);
        marcadores["h" + hermandad.HermandadID] = { marcador, hermandad /*, infoWindow */ };
        clasificarMarcadorHermandad(hermandad, marcador);
    }

    /** Genera el HTML del globo de una hermandad.
     * @param {object} hermandad Datos de la hermandad.
     */
    function contentInfoWindowHermandad(hermandad) {
        var content = "";
        if (hermandad) {
            content =
                "<div class='info-window-content' style='height: 170px; width: 300px;'>" +
                "<div class='col-izquierda'>" +
                "<img src='/" + hermandad.MiniaturaUrl + "'/>" +
                "</div>" +
                "<div class='col-derecha'>" +
                "<h2>" + hermandad.Nombre + "</h2>" +
                "<dl>" +
                itemInfoWindow(textos.iglesiaNombre, hermandad.IglesiaNombre) +
                itemInfoWindow(textos.iglesiaDireccion, hermandad.IglesiaDireccion) +
                "</dl>" +
                "</div>" +
                "</div>";
        }

        var popup = L.popup()
            .setContent(content);

        return popup;
    };

    /** Crea un marcador de un patrocinador con su infowindow, y lo deja registrado en la lista
     * de marcadores.
     * @param {object} patrocinador Datos del patrocinador.
     */
    function nuevoMarcadorPatrocinador(patrocinador) {
        var marcador = crearMarcador(patrocinador.Latitud, patrocinador.Longitud,
            patrocinador.Nombre, iconos['info.b'], 1).bindPopup(contentInfoWindowPatrocinador(patrocinador));
        /*var infoWindow =*/
        // crearInfoWindow(contentInfoWindowPatrocinador(patrocinador),
        //     patrocinador.Latitud, patrocinador.Longitud, -30, 0, marcador);
        marcadores["p" + patrocinador.EmpresaID] = { marcador, patrocinador /*, infoWindow*/ };
    }

    /** Genera el HTML del globo de un patrocinador.
     * @param {object} patrocinador Datos del patrocinador.
     */
    function contentInfoWindowPatrocinador(patrocinador) {
        var content = "";
        if (patrocinador) {
            content =
                "<div>" +
                "<div style='float: left; width: 100px; margin-top: 16px;'>" +
                "<img width='100px' src='/" + patrocinador.LogotipoUrl + "'/>" +
                "</div>" +
                "<div style='float: left; padding-left: 10px;'>" +
                "<h2>" + patrocinador.Nombre + "</h2>" +
                patrocinador.Descripcion +
                "<dl>" +
                itemInfoWindow(textos.patrocinadorDireccion, patrocinador.Direccion) +
                itemInfoWindow(textos.patrocinadorTelefono, patrocinador.Telefono) +
                itemInfoWindowLink(textos.patrocinadorWeb, patrocinador.Web) +
                itemInfoWindowLink(textos.patrocinadorFacebook, patrocinador.Facebook) +
                itemInfoWindowLink(textos.patrocinadorTwitter, patrocinador.Twitter) +
                "</dl>" +
                "</div>" +
                "</div>";
        }

        var popup = L.popup().setContent(content);

        return popup;
    };

    /** Genera un elemento de la lista de características de los globos de información
     * @param {string} texto Título del elemento
     * @param {string} valor Contenido del elemento
     */
    function itemInfoWindow(titulo, valor) {
        if (valor && valor.trim().length) {
            return "<dt>" + titulo + "</dt>" +
                "<dd>" + valor + "</dd>";
        } else {
            return "";
        }
    }

    /** Genera un enlace para la lista de características de los globos de información
     * @param {string} texto Texto del enlace
     * @param {string} url Url del enlace
     */
    function itemInfoWindowLink(texto, url) {
        if (url && url.length) {
            return '<p><a target="_blank" href="http://' + url + '">' + texto + '</a><p>';
        } else {
            return "";
        }
    }

    /** Ajusta la posición y el zoom del mapa para mostrar todos los marcadores de la lista de 
     * marcadores.
     */
    function centrarMarcadores() {
        var bounds = [];
        var idsMarcadores = Object.keys(marcadores);
        var marcadoresVisibles = 0;

        idsMarcadores.forEach(function (marcadorId) {
            var infoMarcador = marcadores[marcadorId];
            if (infoMarcador.enMapa) {
                if (/*infoMarcador.enMapa &&*/ (opciones.marcadoresPatrocinadores || !marcadorId.startsWith("p"))) {
                    marcadoresVisibles += 1;
                    var ll = infoMarcador.marcador.getLatLng();
                    if (ll) {
                        bounds.push([ll.lat, ll.lng]);
                    }
                }
            }
        });

        if (marcadoresVisibles === 0) {
            console.log("Como no hay marcadores, utilizar las coordenadas por defecto para centrar el mapa.", [opciones.latitud, opciones.longitud]);
            mapa.setView([opciones.latitud, opciones.longitud], opciones.zoom);
        } else if (marcadoresVisibles === 1) {
            console.log("Como hay un marcador, utilizamos el zoom por defecto.");
            mapa.setView(bounds[0], opciones.zoom);
        } else {
            console.log("Como más de un marcador, se utiliza fitBounds para establecer el zoom.", bounds);
            mapa.fitBounds(bounds, { padding: [5, 5] });
        }
    }

    /** Obtiene un objeto Date a partir de una fecha en formato json: /Date(...)/
     * @param {string} jsonDate Fecha en formato JSON "/Date(0000000)/ tal como se recibe del servidor."
     */
    function parseJsonDate(jsonDate) {
        // Obtener el número entre paréntesis, convertido en entero.
        var num = jsonDate.match(/\d+/)[0] * 1;
        return new Date(num);
    };

    function cargarSubmenu() {
        //console.log(arguments);

        var ulSubmenu;
        if (arguments.length === 4) {
            textoSubmenu = arguments[0].target.text;
            ulSubmenu = arguments[0].target.nextSibling.childNodes[2];
            tagDiaSeleccionado = arguments[2][0].id;
        } else if (arguments.length === 1) {
            //console.log("Llamada con 1 argumento.", textoBoton, filtroActual, ultimoMenu, ultimoMenu.id);
            if (filtroActual === "TODAS") {
                // Si el menú se va a abrir en el primer
                // nivel no hay que generar ningún submenú.
                return;
            } else {
                var filtroSplit = filtroActual.split("_");
                if (filtroSplit.length === 1) {
                    // Es una hermandad. Hay que buscar la el día al que pertenece.

                } else if (filtroSplit[0] === "TODAS") {
                    // Es un día
                    tagDiaSeleccionado = filtroSplit[1];
                    textoSubmenu = textoBoton;
                }
            }

            ulSubmenu = ultimoMenu[0].childNodes[2];
        } else {
            console.error("Nº de argumentos incorrecto para la función cargarSubmenu.");
        }

        //console.log(tagDiaSeleccionado, textoSubmenu, ulSubmenu);


        // Quitar los elementos anteriores excepto el de "Todas las hermandades".
        for (var i = ulSubmenu.childNodes.length - 1; i >= 0; i--) {
            var liActual = ulSubmenu.childNodes[i];
            //console.log("Quitar: ", liActual);
            menu.multilevelpushmenu('removeitems', liActual);
        }

        var hermandadesParaSubmenu = hermandadesPorDia[tagDiaSeleccionado];
        var nuevosLi = [];

        // Las hermandades se recorren al revés porque al insertar cada una en el menú se hace
        // por arriba, empujando al resto hacia abajo, es decir, la primera que se inserta
        // quedará abajo del todo y la última arriba del todo.
        if (hermandadesParaSubmenu) {
            var keysHermandades = Object.keys(hermandadesParaSubmenu);
            for (var i = keysHermandades.length - 1; i >= 0; i--) {
                var hermandad = hermandadesPorDia[tagDiaSeleccionado][keysHermandades[i]].hermandad;
                //console.log("Submenú " + tagDiaSeleccionado, "Añadir hermandad: " + hermandad.Nombre);
                nuevosLi.push({ name: hermandad.Nombre, id: hermandad.Nombre, link: "#" });
            }

            // Añadir elemento "Todas las hermandades"
            nuevosLi.push({ name: textos.hermandadesTodas, id: "TODAS_" + tagDiaSeleccionado, link: "#" });
            //console.log(nuevosLi);
        }
        var submenu = menu.multilevelpushmenu('findmenusbytitle', textoSubmenu);
        menu.multilevelpushmenu('additems', nuevosLi, submenu);
    }

    function filtrarPorGrupo(ev, menuLevelHolder, item) {
        //console.log(ev, menuLevelHolder, item);
        var tag = item[0].id;
        textoBoton = ev.target.text;
        if (textoBoton === textos.hermandadesTodas && menuLevelHolder[0].dataset.level !== "0") {
            textoBoton = menuLevelHolder[0].childNodes[0].childNodes[1].textContent;
        }
        $("#filtroActual").text(textoBoton);
        filtrarPorTag(tag);

        // Obtener el nombre del último menú abierto para que el menú se abra la próxima vez por el mimsmo sitio.
        ultimoMenu = $('#menu').multilevelpushmenu('activemenu');
        menu.multilevelpushmenu('collapse');

        centrarMarcadores();
    }

    function filtrarPorTag(tag) {
        filtroActual = tag;
        if (tag === "TODAS") {
            tagDiaSeleccionado = "";
            for (var tag in hermandadesPorDia) {
                var hermandadesDia = hermandadesPorDia[tag];
                for (var hermandadId in hermandadesDia) {
                    var hermandadActual = hermandadesDia[hermandadId];
                    hermandadActual.elementosMapa.forEach(function (m) {
                        if ((typeof m.addTo) === "function") {
                            m.addTo(mapa);
                            marcadores["h" + hermandadActual.hermandad.HermandadID].enMapa = true;
                        }
                    });
                }
            }
        } else {
            var tagPartido = tag.split("_");
            if (tagPartido.length === 1) {

                // Mostrar sólo una hermandad
                for (var tag in hermandadesPorDia) {
                    var hermandadesDia = hermandadesPorDia[tag];
                    for (var hermandadId in hermandadesDia) {
                        var hermandadActual = hermandadesDia[hermandadId];
                        hermandadActual.elementosMapa.forEach(function (m) {
                            var mostrarMarcador = hermandadActual.hermandad.Nombre === tagPartido[0];
                            //console.log(mostrarMarcador ? "MOSTRAR " : "OCULTAR", hermandadActual.hermandad.Nombre, m);
                            if ((typeof m.addTo) === "function") {
                                if (mostrarMarcador) {
                                    m.addTo(mapa);
                                    marcadores["h" + hermandadActual.hermandad.HermandadID].enMapa = true;
                                } else {
                                    m.remove();
                                    marcadores["h" + hermandadActual.hermandad.HermandadID].enMapa = false;
                                }
                            }
                        });
                    }
                }
            } else if (tagPartido[0] === "TODAS") {
                //Ocultar todos los elementos del mapa
                for (var tag in hermandadesPorDia) {
                    var hermandadesDia = hermandadesPorDia[tag];
                    for (var hermandadId in hermandadesDia) {
                        var hermandadActual = hermandadesDia[hermandadId];
                        hermandadActual.elementosMapa.forEach(function (m) {
                            //console.log(mostrarMarcadores ? "MOSTRAR " : "OCULTAR", hermandadActual.hermandad.Nombre, m);
                            if ((typeof m.addTo) === "function") {
                                m.remove();
                                marcadores["h" + hermandadActual.hermandad.HermandadID].enMapa = false;
                            }
                        });
                    }
                }

                // Mostrar los elementos del mapa correspondientes a las hermandades que tengan
                // el tag seleccionado.
                tagDiaSelecionado = tagPartido[1];
                var hermandadesDiaMostrar = hermandadesPorDia[tagDiaSelecionado];
                if (hermandadesDiaMostrar) {
                    for (var hermandadId in hermandadesDiaMostrar) {
                        var hermandadActual = hermandadesDiaMostrar[hermandadId];
                        hermandadActual.elementosMapa.forEach(function (m) {
                            if ((typeof m.addTo) === "function") {
                                m.addTo(mapa);
                                marcadores["h" + hermandadActual.hermandad.HermandadID].enMapa = true;
                            }
                        });
                    }
                }
            }
        }
    }

    // Primera carga de datos
    cargarDatos();

    // recargar cada X minutos.
    setInterval(cargarDatos, opciones.refresco * 60000);

    function getParameterByName(name, url) {
        if (!url) {
            url = window.location.href;
        }
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

})();